<div class="game-backdrop" 
     style="background-image: linear-gradient(to bottom, rgba(20, 24, 28, 0.6), #14181c), url('<%= @game.cover_url.gsub('t_thumb', 't_screenshot_huge') %>');">
</div>

<div class="game-container">
  
  <div class="game-sidebar">
    <div class="game-poster-wrapper">
      <img src="<%= @game.cover_url.gsub('t_thumb', 't_cover_big') %>" alt="<%= @game.title %>">
    </div>

    <div class="game-actions">
      <div class="action-row">
        <span class="stat-box">
          <div class="stat-value">
            <%= (@game.reviews.average(:rating) || 0).to_f.round(1) %>
            
            <span class="review-count-small">
              (<%= @game.reviews.count %>)
            </span>
          </div>
          <div class="stat-label">Avg Rating</div>
        </span>

        <span class="stat-box">
          <div class="stat-value">
            <%= @game.logs.count %>
          </div>
          <div class="stat-label">Logs</div>
        </span>
      </div>
      
      <div class="button-row">
        <% if user_signed_in? %>
  
          <% if Review.exists?(user: current_user, game: @game) %>
            <button class="btn-action btn-gray" disabled>Reviewed</button>
          <% else %>
            <%= link_to "Review", new_game_review_path(@game), 
                class: "btn-action btn-green", 
                data: { turbo_frame: "modal" } %>
          <% end %>

          <div class="nav-dropdown">
            <div class="dropdown-trigger btn-action btn-gray">
              Add to List
              <span class="dropdown-arrow">▼</span>
            </div>

            <div class="dropdown-menu">
              <% if current_user.lists.any? %>
                <% current_user.lists.each do |list| %>
                  
                  <%= form_with url: add_game_list_path(list), method: :post, data: { turbo: false }, class: "dropdown-form" do %>
                    <%= hidden_field_tag :game_id, @game.game_id %>
                    
                    <button type="submit" class="dropdown-item">
                      <%= list.title %>
                    </button>
                  <% end %>

                <% end %>
              <% else %>
                <div class="dropdown-item disabled">No lists yet</div>
                <div class="dropdown-divider"></div>
                <%= link_to "Create New List", new_list_path, class: "dropdown-item" %>
              <% end %>
            </div>
          </div>

        <% else %>
          <%= link_to "Sign in to Log", new_user_session_path, class: "btn-action btn-gray", data: { turbo_frame: "modal" } %>
        <% end %>
      </div>
      
    </div>
  </div>

  <div class="game-details">
    
    <h1 class="game-title">
      <%= @game.title %> 
      <span class="game-year">(<%= @game.release_date&.year %>)</span>
    </h1>

    <div class="game-meta-row">
  
      <div class="meta-group">
        <span class="meta-label">Developer</span>
        <span class="meta-value">
          <% if @game.developers.any? %>
            <% @game.developers.each_with_index do |dev, index| %>
              <%= link_to dev.name, developer_path(dev), class: "hero-game-link", style: "font-size: 1rem; font-weight: normal; border: none;" %>
              <%= ", " unless index == @game.developers.size - 1 %>
            <% end %>
          <% else %>
            N/A
          <% end %>
        </span>
      </div>

      <div class="meta-group">
        <span class="meta-label">Publisher</span>
        <span class="meta-value">
          <% if @game.publishers.any? %>
            <% @game.publishers.each_with_index do |pub, index| %>
              <%= link_to pub.name, publisher_path(pub), class: "hero-game-link", style: "font-size: 1rem; font-weight: normal; border: none;" %>
              <%= ", " unless index == @game.publishers.size - 1 %>
            <% end %>
          <% else %>
            N/A
          <% end %>
        </span>
      </div>

    </div>

    <div class="game-summary">
      <h3 class="section-heading">SYNOPSIS</h3>
      <p><%= @game.summary %></p>
    </div>

    <div class="game-specs">
      <div class="spec-group">
        <span class="spec-label">Genres</span>
        <span class="spec-content">
          <%= @game.genres.map(&:name).join(", ") %>
        </span>
      </div>
      
      <div class="spec-group">
        <span class="spec-label">Platforms</span>
        <span class="spec-content">
          <%= @game.platforms.map(&:name).join(", ") %>
        </span>
      </div>
    </div>

    <div class="reviews-container">
      
      <%= turbo_frame_tag "reviews_feed" do %>
        
        <div class="reviews-header-row">
          <h3 class="section-heading" style="border: none; margin: 0;">REVIEWS</h3>
          
          <div class="review-sort-options">
            <span class="sort-label">Sort by</span>
            
            <%= link_to "Newest", game_path(@game, sort: "newest"), 
                class: "sort-link #{@sort_type == 'newest' ? 'active' : ''}" %>
            
            <%= link_to "Highest", game_path(@game, sort: "highest"), 
                class: "sort-link #{@sort_type == 'highest' ? 'active' : ''}" %>
            
            <%= link_to "Lowest", game_path(@game, sort: "lowest"), 
                class: "sort-link #{@sort_type == 'lowest' ? 'active' : ''}" %>
          </div>
        </div>

        <div style="border-bottom: 1px solid #456; margin-bottom: 20px; margin-top: 10px;"></div>

        <% if @reviews.any? %>
          <% @reviews.each do |review| %>
            <div class="review-card">
              
              <div class="review-avatar">
                <%= review.user.username[0].upcase %>
              </div>

              <div class="review-content">
                <div class="review-header">
                  <span class="review-user"><%= review.user.username %></span>
                  <span class="review-rating">
                    <% review.rating.to_i.times do %>★<% end %>
                    <% if review.rating % 1 != 0 %>½<% end %>
                  </span>
                </div>
                
                <div class="review-body">
                  <%= simple_format(review.review_text) %>
                </div>
                
                <div class="review-date">
                  <%= review.review_date.strftime("%b %d, %Y") %>
                </div>
              </div>

            </div>
          <% end %>

        <div class="pagination-controls">
          
          <% if @page > 1 %>
            <%= link_to "←", game_path(@game, page: @page - 1, sort: @sort_type), class: "pagination-btn" %>
          <% else %>
            <span class="pagination-btn disabled">←</span>
          <% end %>

          <div class="pagination-numbers">
            <% 
               start_p = [@page - 2, 1].max
               end_p   = [@page + 2, @total_pages].min
            %>

            <% if start_p > 1 %>
              <%= link_to "1", game_path(@game, page: 1, sort: @sort_type), class: "page-number" %>
              <% if start_p > 2 %>
                <span class="page-dots">...</span>
              <% end %>
            <% end %>

            <% (start_p..end_p).each do |p| %>
              <%= link_to p, game_path(@game, page: p, sort: @sort_type), 
                  class: "page-number #{'active' if p == @page}" %>
            <% end %>

            <% if end_p < @total_pages %>
              <% if end_p < @total_pages - 1 %>
                <span class="page-dots">...</span>
              <% end %>
              <%= link_to @total_pages, game_path(@game, page: @total_pages, sort: @sort_type), class: "page-number" %>
            <% end %>
          </div>

          <% if @more_reviews_exist %>
            <%= link_to "→", game_path(@game, page: @page + 1, sort: @sort_type), class: "pagination-btn" %>
          <% else %>
            <span class="pagination-btn disabled">→</span>
          <% end %>

        </div>

        <% else %>
          <p style="color: #678; font-style: italic; margin-top: 20px;">
            No reviews found.
          </p>
        <% end %>

      <% end %> 
    </div>

  </div>
</div>
