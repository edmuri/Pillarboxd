<div class="library-container">

  <div class="header-section">
  
    <div class="header-left">
      <h1 class="page-title">Games Library</h1>
      <p class="library-stats">
        <% if params[:query].present? %>
          Found <strong><%= @games.count %></strong> results for "<em><%= params[:query] %></em>"
        <% else %>
          There are <strong><%= number_with_delimiter(@all_games.count) %></strong> games.
        <% end %>
      </p>
    </div>

    <div class="header-right">
      <%= form_with url: games_path, method: :get, local: true, class: "search-form" do |form| %>
        
        <%= form.text_field :query, 
              value: params[:query], 
              placeholder: "Find a game...", 
              class: "search-input" 
        %>

        <% if params[:query].present? %>
          <%= link_to "✕", games_path, class: "clear-search-btn", title: "Clear Filter" %>
        <% end %>

        <%= form.submit "Search", class: "search-button" %>
      <% end %>
    </div>
    
  </div>

  <div class="game-grid">
    <% @games.each do |game| %>
      <%= link_to game_path(game), class: "game-card" do %>
        
        <div class="poster-frame">
          <% if game.cover_url.present? && game.cover_url != "NO COVER" %>
            <img src="<%= game.cover_url %>" alt="<%= game.title %>" loading="lazy">
          <% else %>
            <div class="no-image">
              Cover Art<br>Not Available
            </div>
          <% end %>
        </div>

        <div class="game-info">
          <span class="title"><%= game.title %></span>
        </div>
        
      <% end %>
    <% end %>
  </div>

  <div class="pagination-controls">
    
    <% if @page > 1 %>
      <%= link_to "←", games_path(page: @page - 1, query: params[:query]), class: "pagination-btn" %>
    <% else %>
      <span class="pagination-btn disabled">←</span>
    <% end %>

    <div class="pagination-numbers">
      <% 
         start_p = [@page - 2, 1].max
         end_p   = [@page + 2, @total_pages].min
      %>

      <% if start_p > 1 %>
        <%= link_to "1", games_path(page: 1, query: params[:query]), class: "page-number" %>
        <% if start_p > 2 %>
          <span class="page-dots">...</span>
        <% end %>
      <% end %>

      <% (start_p..end_p).each do |p| %>
        <%= link_to p, games_path(page: p, query: params[:query]), 
            class: "page-number #{'active' if p == @page}" %>
      <% end %>

      <% if end_p < @total_pages %>
        <% if end_p < @total_pages - 1 %>
          <span class="page-dots">...</span>
        <% end %>
        <%= link_to @total_pages, games_path(page: @total_pages, query: params[:query]), class: "page-number" %>
      <% end %>
    </div>

    <% if @more_exists %>
      <%= link_to "→", games_path(page: @page + 1, query: params[:query]), class: "pagination-btn" %>
    <% else %>
      <span class="pagination-btn disabled">→</span>
    <% end %>

  </div>
  
  <% if @games.empty? %>
    <div style="text-align: center; margin-top: 50px; color: #678;">
      <h2>No games found matching "<%= params[:query] %>"</h2>
      <%= link_to "Clear Search", games_path, style: "color: #00e054;" %>
    </div>
  <% end %>

</div>
